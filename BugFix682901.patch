# HG changeset patch
# User Aman Dwivedi <dwivedi.aman96@gmail.com>
# Date 1485422606 -19800
#      Thu Jan 26 14:53:26 2017 +0530
# Node ID 50e99b18b2eb0a0a937e670d418034fe1e885d3d
# Parent  fbdfcecf0c774d2221f11aed5a504d5591c774e0
Bug 682901 - catch the case where .finish() gets called before waitForExplicitFinish(), r=jdm.

diff --git a/testing/mochitest/tests/Harness_sanity/mochitest.ini b/testing/mochitest/tests/Harness_sanity/mochitest.ini
--- a/testing/mochitest/tests/Harness_sanity/mochitest.ini
+++ b/testing/mochitest/tests/Harness_sanity/mochitest.ini
@@ -42,3 +42,4 @@ skip-if = toolkit == 'android' # we use 
 fail-if = true
 [test_spawn_task.html]
 [test_sanity_waitForCondition.html]
+[test_finish_called_before_waitForExplicitFinish.html]
\ No newline at end of file
diff --git a/testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html b/testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html
new file mode 100644
--- /dev/null
+++ b/testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html
@@ -0,0 +1,27 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=682901
+-->
+<head>
+  <title>Test for Bug 682901</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=682901">Mozilla Bug 682901</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+/** Test for Bug 682901 **/
+SimpleTest.expectExplicitFinish();
+SimpleTest.finish();
+SimpleTest.waitForExplicitFinish();
+</script>
+</pre>
+</body>
+</html>
diff --git a/testing/mochitest/tests/SimpleTest/SimpleTest.js b/testing/mochitest/tests/SimpleTest/SimpleTest.js
--- a/testing/mochitest/tests/SimpleTest/SimpleTest.js
+++ b/testing/mochitest/tests/SimpleTest/SimpleTest.js
@@ -1063,6 +1063,16 @@ SimpleTest.timeout = function() {
  * SimpleTest.waitForExplicitFinish() has been invoked.
 **/
 SimpleTest.finish = function() {
+    /* disallow calling finish before waitForExplicitFinish
+    */
+    if (SimpleTest._stopOnLoad) {
+        if (SimpleTest._expectingExplicitFinish) {
+            SimpleTest.ok(true, "[SimpleTest.finish()] waitForExplicitFinish() has been invoked");
+        }
+        else {
+            SimpleTest.ok(false, "[SimpleTest.finish()] waitForExplicitFinish() has not been invoked");
+        }
+    }
     if (SimpleTest._alreadyFinished) {
         var err = "[SimpleTest.finish()] this test already called finish!";
         if (parentRunner) {
@@ -1356,6 +1366,10 @@ SimpleTest.expectRegisteredServiceWorker
     SimpleTest._expectingRegisteredServiceWorker = true;
 };
 
+SimpleTest.expectExplicitFinish = function () {
+    SimpleTest._expectingExplicitFinish = true;
+};
+
 /**
  * Resets any state this SimpleTest object has.  This is important for
  * browser chrome mochitests, which reuse the same SimpleTest object
@@ -1371,6 +1385,7 @@ SimpleTest.reset = function () {
 if (isPrimaryTestWindow) {
     addLoadEvent(function() {
         if (SimpleTest._stopOnLoad) {
+            SimpleTest._stopOnLoad = false;
             SimpleTest.finish();
         }
     });
